<!DOCTYPE html>
<html>

<head>
    <title>Peer通信 with QR</title>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- QRコード生成ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <!-- PeerJSライブラリ -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>

<body>
    <h1>Peer通信 + QRコード</h1>

    <div>
        あなたのID: <span id="my-id">取得中...</span>
    </div>
    <div id="qr"></div>

    <div>
        <p>接続相手ID: <input type="text" id="target-id"></p>
        <button onclick="connect()">接続</button>
    </div>

    <div>
        <input type="text" id="msg">
        <button onclick="send()">送信</button>
    </div>

    <pre id="log"></pre>

    <script>
        // ページが完全に読み込まれてから実行
        document.addEventListener('DOMContentLoaded', function () {
            const peer = new Peer();
            let conn;

            peer.on('open', (id) => {
                document.getElementById('my-id').textContent = id;

                const connectUrl = window.location.origin + window.location.pathname + '?id=' + id;

                // jQueryのQRコード生成
                if (typeof $ !== 'undefined' && $.fn.qrcode) {
                    $('#qr').qrcode(connectUrl);
                } else {
                    // jQueryまたはQRCodeライブラリが読み込まれていない場合は少し待ってから再試行
                    setTimeout(() => {
                        if (typeof $ !== 'undefined' && $.fn.qrcode) {
                            $('#qr').qrcode(connectUrl);
                        } else {
                            console.error('jQuery QRCodeライブラリが読み込まれていません');
                            document.getElementById('qr').innerHTML = '<p>QRコードの生成に失敗しました</p>';
                        }
                    }, 1000);
                }
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
            });

            // URLパラメータからIDを取得して自動接続
            const params = new URLSearchParams(window.location.search);
            if (params.has('id')) {
                const targetId = params.get('id');
                document.getElementById('target-id').value = targetId;
                connect(); // 自動接続
            }

            function connect() {
                const targetId = document.getElementById('target-id').value;
                conn = peer.connect(targetId);
                setupConnection();
            }

            function setupConnection() {
                conn.on('open', () => {
                    log('接続しました！');
                });
                conn.on('data', (data) => {
                    log('受信: ' + data);
                });
            }

            function send() {
                const msg = document.getElementById('msg').value;
                conn.send(msg);
                log('送信: ' + msg);
            }

            function log(message) {
                document.getElementById('log').textContent += message + '\n';
            }

            // グローバル関数として定義（HTMLから呼び出すため）
            window.connect = connect;
            window.send = send;
        });
    </script>
</body>

</html>