<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>Peeré€šä¿¡ + QR + ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</title>
  <!-- jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>

<body>
  <h1>Peeré€šä¿¡ + QRã‚³ãƒ¼ãƒ‰ + ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</h1>

  <div>
    ã‚ãªãŸã®ID: <span id="my-id">å–å¾—ä¸­...</span>
  </div>
  <div id="qr"></div>

  <div>
    <p>æ¥ç¶šç›¸æ‰‹ID: <input type="text" id="target-id"></p>
    <button onclick="connect()">æ¥ç¶š</button>
  </div>

  <div>
    <input type="text" id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
    <button onclick="send()">é€ä¿¡</button>
  </div>

  <div>
    <input type="file" id="fileInput" multiple>
    <button onclick="sendFiles()">ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</button>
    <button onclick="clearFiles()">é¸æŠã‚¯ãƒªã‚¢</button>
  </div>

  <pre id="log"></pre>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const peer = new Peer();
      let conn;

      peer.on('open', (id) => {
        document.getElementById('my-id').textContent = id;
        const connectUrl = window.location.origin + window.location.pathname + '?id=' + id;
        if ($ && $.fn.qrcode) {
          $('#qr').qrcode({
            width: 128,
            height: 128,
            text: connectUrl
          });
        }
      });

      peer.on('connection', (connection) => {
        conn = connection;
        log(`ç›¸æ‰‹ (${connection.peer}) ã‹ã‚‰æ¥ç¶šè¦æ±‚ãŒã‚ã‚Šã¾ã—ãŸã€‚`);
        setupConnection();
      });

      // URLã‚¯ã‚¨ãƒªã«IDãŒã‚ã‚Œã°è‡ªå‹•æ¥ç¶š
      const params = new URLSearchParams(window.location.search);
      if (params.has('id')) {
        const targetId = params.get('id');
        document.getElementById('target-id').value = targetId;
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æ¥ç¶šã—ãªã„ã¨PeerJSã®æº–å‚™ãŒé–“ã«åˆã‚ãªã„å ´åˆãŒã‚ã‚‹
        setTimeout(() => {
          log(`${targetId} ã«è‡ªå‹•æ¥ç¶šã—ã¾ã™...`);
          connect();
        }, 500);
      }

      function connect() {
        const targetId = document.getElementById('target-id').value;
        if (!targetId) {
            log('æ¥ç¶šç›¸æ‰‹ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        log(`${targetId} ã«æ¥ç¶šã—ã¾ã™...`);
        conn = peer.connect(targetId);
        setupConnection();
      }

      function setupConnection() {
        conn.on('open', () => {
          log(`æ¥ç¶šæˆåŠŸï¼ (${conn.peer})`);
          // æ¥ç¶šãŒæˆåŠŸã—ãŸã‚‰ã€ç›¸æ‰‹ã®IDå…¥åŠ›æ¬„ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚‚è‰¯ã„
          document.getElementById('target-id').disabled = true;
          document.querySelector('button[onclick="connect()"]').disabled = true;
        });

        conn.on('data', (data) => {
          if (data.type === 'text') {
            log(`å—ä¿¡: ${data.text}`);
          } else if (data.type === 'file') {
            const blob = new Blob([data.buffer], { type: data.mime });
            const url = URL.createObjectURL(blob);
            const logEl = document.getElementById('log');

            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
            const container = document.createElement('div');
            container.style.margin = '8px 0';
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯
            const a = document.createElement('a');
            a.href = url;
            a.download = data.name;
            a.textContent = `ğŸ“ ${data.name} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
            a.style.display = 'block';
            a.style.marginBottom = '4px';

            container.appendChild(a);

            // ç”»åƒãªã‚‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
            if (data.mime && data.mime.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = url;
              img.alt = data.name;
              img.style.maxWidth = '300px';
              img.style.maxHeight = '300px';
              img.style.display = 'block';
              img.style.marginTop = '4px';
              container.appendChild(img);
            }
            
            // ãƒ­ã‚°è¦ç´ ã«ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ 
            logEl.appendChild(container);
            log(`ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡: ${data.name} (${(data.size / 1024).toFixed(2)} KB)`);
            
            // å—ä¿¡å¾Œã«Blob URLã‚’ãƒ¡ãƒ¢ãƒªã‹ã‚‰è§£æ”¾ã™ã‚‹ã®ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
            // ãŸã ã—ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„è¡¨ç¤ºãŒçµ‚ã‚ã‚‹ã¾ã§å¾…ã¤å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€ã“ã“ã§ã¯è§£æ”¾ã—ãªã„
            // a.onclick = () => { setTimeout(() => { URL.revokeObjectURL(url); }, 1000); };
          }
        });
        
        conn.on('close', () => {
            log('æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸã€‚');
            document.getElementById('target-id').disabled = false;
            document.querySelector('button[onclick="connect()"]').disabled = false;
        });

        conn.on('error', (err) => {
            log('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err);
        });
      }

      function send() {
        const msg = document.getElementById('msg').value;
        if (!msg.trim()) {
          log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™');
          return;
        }
        if (conn && conn.open) {
          conn.send({ type: 'text', text: msg });
          log('é€ä¿¡: ' + msg);
          document.getElementById('msg').value = '';
        } else {
          log('æœªæ¥ç¶šã§ã™');
        }
      }

      function sendFiles() {
        const files = document.getElementById('fileInput').files;
        if (!conn || !conn.open) {
          log('æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }
        if (files.length === 0) {
          log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
          return;
        }

        for (const file of files) {
          const reader = new FileReader();
          reader.onload = function (e) {
            conn.send({
              type: 'file',
              name: file.name,
              mime: file.type || 'application/octet-stream',
              buffer: e.target.result,
              size: file.size
            });
            log(`é€ä¿¡: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
          };
          reader.readAsArrayBuffer(file);
        }
      }

      function clearFiles() {
        document.getElementById('fileInput').value = '';
        log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      }

      // â˜…â˜…â˜…â˜…â˜… å•é¡Œã®é–¢æ•°ã‚’ä¿®æ­£ â˜…â˜…â˜…â˜…â˜…
      function log(message) {
        const logEl = document.getElementById('log');
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒãƒ¼ãƒ‰ã¨ã—ã¦è¿½åŠ ã—ã€æ”¹è¡Œã‚‚è¿½åŠ ã™ã‚‹
        logEl.appendChild(document.createTextNode(message + '\n'));
        // å¸¸ã«ä¸€ç•ªä¸‹ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦æœ€æ–°ã®ãƒ­ã‚°ã‚’è¦‹ã‚„ã™ãã™ã‚‹
        logEl.scrollTop = logEl.scrollHeight;
      }
      
      // å…ƒã®ã‚³ãƒ¼ãƒ‰ã«ã‚ã£ãŸãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã¯è¤‡é›‘ãªã®ã§å‰Šé™¤ã—ã¾ã—ãŸã€‚
      // a.downloadå±æ€§ãŒã‚ã‚Œã°ã€é€šå¸¸ã¯ã‚¯ãƒªãƒƒã‚¯ã ã‘ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚
      // ã¾ãŸã€ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡æ™‚ã®è¡¨ç¤ºã‚’divã§å›²ã‚€ã“ã¨ã§ã€ãƒ­ã‚°ã¨ã®åŒºåˆ¥ã‚’ã¤ã‘ã‚„ã™ãã—ã¾ã—ãŸã€‚

      window.connect = connect;
      window.send = send;
      window.sendFiles = sendFiles;
      window.clearFiles = clearFiles;
    });
  </script>
</body>

</html>
