<!DOCTYPE html>
<html>

<head>
    <title>Peeré€šä¿¡ + QR + ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</title>
    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>

<body>
    <h1>Peeré€šä¿¡ + QRã‚³ãƒ¼ãƒ‰ + ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</h1>

    <div>
        ã‚ãªãŸã®ID: <span id="my-id">å–å¾—ä¸­...</span>
    </div>
    <div id="qr"></div>

    <div>
        <p>æ¥ç¶šç›¸æ‰‹ID: <input type="text" id="target-id"></p>
        <button onclick="connect()">æ¥ç¶š</button>
    </div>

    <div>
        <input type="text" id="msg" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›">
        <button onclick="send()">é€ä¿¡</button>
    </div>

    <div>
        <input type="file" id="fileInput" multiple>
        <button onclick="sendFiles()">ãƒ•ã‚¡ã‚¤ãƒ«é€ä¿¡</button>
        <button onclick="clearFiles()">é¸æŠã‚¯ãƒªã‚¢</button>
    </div>

    <pre id="log"></pre>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const peer = new Peer();
            let conn;

            peer.on('open', (id) => {
                document.getElementById('my-id').textContent = id;
                const connectUrl = window.location.origin + window.location.pathname + '?id=' + id;

                // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
                if (typeof $ !== 'undefined' && $.fn.qrcode) {
                    $('#qr').qrcode(connectUrl);
                } else {
                    setTimeout(() => {
                        if (typeof $ !== 'undefined' && $.fn.qrcode) {
                            $('#qr').qrcode(connectUrl);
                        } else {
                            console.error('QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                    }, 1000);
                }
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
            });

            const params = new URLSearchParams(window.location.search);
            if (params.has('id')) {
                document.getElementById('target-id').value = params.get('id');
                connect();
            }

            function connect() {
                const targetId = document.getElementById('target-id').value;
                conn = peer.connect(targetId);
                setupConnection();
            }

            function setupConnection() {
                conn.on('open', () => {
                    log('æ¥ç¶šã—ã¾ã—ãŸï¼');
                });

                conn.on('data', (data) => {
                    if (data.type === 'text') {
                        log('å—ä¿¡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰: ' + data.text);
                    } else if (data.type === 'file') {
                        // ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡
                        const blob = new Blob([data.buffer], { type: data.mime });
                        
                        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
                        const downloadDiv = document.createElement('div');
                        downloadDiv.style.margin = '10px 0';
                        downloadDiv.style.padding = '10px';
                        downloadDiv.style.backgroundColor = '#f0f0f0';
                        downloadDiv.style.border = '1px solid #ccc';
                        downloadDiv.style.borderRadius = '5px';
                        
                        const downloadLink = document.createElement('a');
                        downloadLink.textContent = `ğŸ“ ${data.name} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰`;
                        downloadLink.style.textDecoration = 'none';
                        downloadLink.style.color = '#0066cc';
                        downloadLink.style.fontWeight = 'bold';
                        downloadLink.style.cursor = 'pointer';
                        downloadLink.style.display = 'inline-block';
                        downloadLink.style.padding = '5px 10px';
                        downloadLink.style.backgroundColor = '#e6f3ff';
                        downloadLink.style.border = '1px solid #0066cc';
                        downloadLink.style.borderRadius = '3px';
                        
                        // ã‚ˆã‚Šç¢ºå®Ÿãªãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ–¹æ³•
                        downloadLink.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            try {
                                // æ–¹æ³•1: FileSaver.jsé¢¨ã®å®Ÿè£…
                                const url = URL.createObjectURL(blob);
                                const tempLink = document.createElement('a');
                                tempLink.style.display = 'none';
                                tempLink.href = url;
                                tempLink.download = data.name;
                                
                                // DOMã«è¿½åŠ ã—ã¦ã‚¯ãƒªãƒƒã‚¯
                                document.body.appendChild(tempLink);
                                tempLink.click();
                                
                                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                                setTimeout(() => {
                                    document.body.removeChild(tempLink);
                                    URL.revokeObjectURL(url);
                                }, 100);
                                
                                log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–‹å§‹: ${data.name}`);
                            } catch (error) {
                                console.error('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                                
                                // æ–¹æ³•2: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ - æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
                                try {
                                    const url = URL.createObjectURL(blob);
                                    const newWindow = window.open(url, '_blank');
                                    if (!newWindow) {
                                        log('ã‚¨ãƒ©ãƒ¼: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                                    } else {
                                        log(`æ–°ã—ã„ã‚¿ãƒ–ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ãã¾ã—ãŸ: ${data.name}`);
                                    }
                                } catch (error2) {
                                    log(`ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${data.name} - ${error2.message}`);
                                }
                            }
                        });
                        
                        downloadDiv.appendChild(downloadLink);
                        
                        // è¿½åŠ ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯ä¿å­˜ç”¨ï¼‰
                        const directLink = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        directLink.href = url;
                        directLink.download = data.name;
                        directLink.textContent = 'ï¼ˆå³ã‚¯ãƒªãƒƒã‚¯â†’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ï¼‰';
                        directLink.style.marginLeft = '10px';
                        directLink.style.fontSize = '12px';
                        directLink.style.color = '#666';
                        
                        downloadDiv.appendChild(document.createElement('br'));
                        downloadDiv.appendChild(directLink);
                        
                        document.getElementById('log').appendChild(downloadDiv);
                        log(`ãƒ•ã‚¡ã‚¤ãƒ«å—ä¿¡: ${data.name} (${(data.buffer.byteLength / 1024).toFixed(2)} KB)`);
                    }
                });
            }

            function send() {
                const msg = document.getElementById('msg').value;
                if (!msg.trim()) {
                    log('ã‚¨ãƒ©ãƒ¼: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã§ã™');
                    return;
                }
                
                if (conn && conn.open) {
                    conn.send({ type: 'text', text: msg });
                    log('é€ä¿¡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰: ' + msg);
                    document.getElementById('msg').value = ''; // é€ä¿¡å¾Œã«ã‚¯ãƒªã‚¢
                } else {
                    log('ã‚¨ãƒ©ãƒ¼: æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }

            function clearFiles() {
                document.getElementById('fileInput').value = '';
                log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }

            function sendFiles() {
                const files = document.getElementById('fileInput').files;
                if (!conn || !conn.open) {
                    log('ã‚¨ãƒ©ãƒ¼: æ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                if (files.length === 0) {
                    log('ã‚¨ãƒ©ãƒ¼: ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    return;
                }

                log(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡é–‹å§‹...`);

                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    
                    reader.onload = function () {
                        try {
                            const arrayBuffer = reader.result;
                            const fileData = {
                                type: 'file',
                                name: file.name,
                                mime: file.type || 'application/octet-stream',
                                buffer: arrayBuffer,
                                size: file.size
                            };
                            
                            conn.send(fileData);
                            log(`é€ä¿¡å®Œäº†: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
                        } catch (error) {
                            log(`é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${file.name} - ${error.message}`);
                        }
                    };
                    
                    reader.onerror = function() {
                        log(`èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${file.name}`);
                    };
                    
                    reader.readAsArrayBuffer(file);
                }
            }

            function log(message) {
                document.getElementById('log').textContent += message + '\n';
            }

            // HTMLãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã™é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
            window.connect = connect;
            window.send = send;
            window.sendFiles = sendFiles;
            window.clearFiles = clearFiles;
        });
    </script>
</body>

</html>
